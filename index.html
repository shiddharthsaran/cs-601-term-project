<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="./styles/main.css" rel="stylesheet">
  </head>
  <body>
    <h1 id="searchTitle">Stock Search</h1>
    <input type="text" id="searchInput" placeholder="Search for Stocks">
    <ul id="searchSuggestions"></ul>
    <a href="#" id="searchBtn" class="btn btn-primary">Search</a>
    
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" role="switch" id="stockUserSearch">
    </div>
    <div id="portfolioGraph" style="width: 400px; height: 400px;"></div>


    <!-- <h1>User Search</h1>
    <input type="text" id="userSearch">
    <ul id="userSuggestions"></ul> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="module">
      import {getStockSearch} from './modules/main.js';
      import {getUserSearch} from './modules/main.js';
      import {formatDate} from './modules/main.js';
      import {getStockPrices} from './modules/main.js';
     
      document.addEventListener("DOMContentLoaded", function(){
        const searchInput = document.getElementById("searchInput");
        const stockUserSearch = document.getElementById("stockUserSearch");
        const searchTitle = document.getElementById("searchTitle");
        const searchSuggestions = document.getElementById("searchSuggestions");
        const searchBtn = document.getElementById("searchBtn");
        const requestHeader = new Headers();
        requestHeader.set("Content-Type", "application/json");
        let userDetails = {
          "userAmount":1000,
          "userStocks":{},
          "userFriends":{}
        };
        let stockUserSearchBool = true;
        stockUserSearch.addEventListener("click", () => {
          if(stockUserSearchBool){
            searchTitle.innerText = "User Search";
            searchInput.placeholder = "Search for Users";
            stockUserSearchBool = false;
            searchInput.value = "";
            while (searchSuggestions.firstChild) {
              searchSuggestions.removeChild(searchSuggestions.lastChild);
            }
          }
          else{
            searchTitle.innerText = "Stock Search";
            searchInput.placeholder = "Search for Stocks";
            stockUserSearchBool = true;
            searchInput.value = "";
            while (searchSuggestions.firstChild) {
              searchSuggestions.removeChild(searchSuggestions.lastChild);
            }
          }
        })
        searchInput.addEventListener("keyup", function(){
          const userInput = searchInput.value;
          if(stockUserSearchBool){
            getStockSearch(userInput);
          }
          else{
            getUserSearch(userInput);
          }
          
        })
        searchBtn.addEventListener("click", function(){
          const firstSuggestion = document.getElementById("searchSuggestions").firstChild;
          let userInput;
          if(firstSuggestion == null){
            userInput = searchInput.value;
          }
          else{
            userInput = firstSuggestion.innerText;
          }
          if (userInput.length > 0){
            if(stockUserSearchBool){
              console.log("stock " + userInput);
            }
            else{
              console.log("user " + userInput);
            }
          }
        })
        let localUserDetails = JSON.parse(localStorage.getItem('userDetails'));
        if(localUserDetails == null){
          localStorage.setItem('userDetails',JSON.stringify(userDetails));
          localUserDetails = JSON.parse(localStorage.getItem('userDetails'));
        }
        // console.log(localUserDetails);
        let userStocks = localUserDetails['userStocks'];
        let chartDates = [];
        let chartDataPromises = [];
        let currentDate = new Date();
        let dateIter = 1;
        while(chartDates.length < 5){
          let tempDate = new Date(currentDate);
          tempDate.setDate(tempDate.getDate() - dateIter);
          if(tempDate.getDay() >= 1 && tempDate.getDay() <= 5){
            chartDates.push(formatDate(tempDate));
          }
          dateIter++;

        }
        chartDates.reverse();
		let chartData = [{
			type:"scatter",
			mode:"lines",
			name:"",
			x:chartDates,
			y:[null,null,null,null,null]
		}]
		Plotly.newPlot('portfolioGraph', chartData);
        if(Object.keys(userStocks).length > 0){
          Object.keys(userStocks).forEach(ticker => {
			if(userStocks[ticker] > 0){
				chartDataPromises.push(getStockPrices(ticker, chartDates));
			}
            
            
          })
          Promise.all(chartDataPromises)
          .then(chartData => {
            Plotly.newPlot('portfolioGraph', chartData);
          })          
        }
        
        
      })
          
    </script>
  </body>
</html>
