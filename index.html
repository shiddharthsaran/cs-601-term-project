<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="./styles/main.css" rel="stylesheet">
  </head>
  <body class="bg-black">
	<div class="container align-items-center justify-content-center wrapper text-white bg-dark">
		<div class="row">
			<div class="justify-content-center align-items-center d-flex">
				<img src="./static/images/Designer.jpeg" class="img-fluid">
			</div>
			<div class="col-sm-12 col-md-6 col-lg-4 col-xl-4">
				<div>
					<div id="portfolios"></div>
					<button class="btn btn-success" id="addPortfolio">Add</button>
					<ul id="portfolioLis"></ul>
					<p id="portfolioValue"></p>
					<p id="userAmount"></p>

				</div>
				
			</div>
			<div class="col-sm-12 col-md-6 col-lg-4 col-xl-4">
				<p id="searchTitle">Stock Search</p>
				<input type="text" id="searchInput" class="input-css" placeholder="Search for Stocks">
				<ul id="searchSuggestions"></ul>
				<a href="#" id="searchBtn" class="btn btn-primary btn-full">Search</a>
				<div class="form-check form-switch">
					<input class="form-check-input" type="checkbox" role="switch" id="stockUserSearch">
				</div>
	
			</div>
			<div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
				<div id="portfolioGraph"></div>
			</div>
	
		</div>

	</div>
	
	

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="module">
      import {getStockSearch} from './modules/main.js';
      import {getUserSearch} from './modules/main.js';
      import {formatDate} from './modules/main.js';
      import {getStockPrices} from './modules/main.js';
     
      document.addEventListener("DOMContentLoaded", function(){
        const searchInput = document.getElementById("searchInput");
        const stockUserSearch = document.getElementById("stockUserSearch");
        const searchTitle = document.getElementById("searchTitle");
        const searchSuggestions = document.getElementById("searchSuggestions");
        const searchBtn = document.getElementById("searchBtn");
		const portfolioValue = document.getElementById("portfolioValue");
		const userAmount = document.getElementById("userAmount");
		const addPortfolio = document.getElementById("addPortfolio");
		


        
        let portfolioDetails = {
			"currentPortfolioId":1,
			"portfolioId":2,
			1:{

				"userAmount":1000,
				"userStocks":{},
				"userFriends":{},
				"portfolioValue":0

			}
          
        };
        let stockUserSearchBool = true;
		
        stockUserSearch.addEventListener("click", () => {
          if(stockUserSearchBool){
            searchTitle.innerText = "User Search";
            searchInput.placeholder = "Search for Users";
            stockUserSearchBool = false;
            searchInput.value = "";
            while (searchSuggestions.firstChild) {
              searchSuggestions.removeChild(searchSuggestions.lastChild);
            }
          }
          else{
            searchTitle.innerText = "Stock Search";
            searchInput.placeholder = "Search for Stocks";
            stockUserSearchBool = true;
            searchInput.value = "";
            while (searchSuggestions.firstChild) {
              searchSuggestions.removeChild(searchSuggestions.lastChild);
            }
          }
        })
        searchInput.addEventListener("keyup", function(){
          const userInput = searchInput.value;
          if(stockUserSearchBool){
            getStockSearch(userInput);
          }
          else{
            getUserSearch(userInput);
          }
          
        })
        
        let localPortfolioDetails = JSON.parse(localStorage.getItem('portfolioDetails'));
        if(localPortfolioDetails == null){
          localStorage.setItem('portfolioDetails',JSON.stringify(portfolioDetails));
          localPortfolioDetails = JSON.parse(localStorage.getItem('portfolioDetails'));
        }
		let currentPortfolioId;
		const portfolioLis = document.getElementById("portfolioLis");
		Object.keys(localPortfolioDetails).forEach( keyVal => {
			if(keyVal == 'currentPortfolioId' || keyVal == 'portfolioId'){
				currentPortfolioId = localPortfolioDetails['currentPortfolioId'];
			}
	
			else{
				const li = document.createElement("li");
				li.id = "portfolio" + keyVal;
				if(keyVal == localPortfolioDetails['currentPortfolioId']){
					const span = document.createElement("span");
					span.innerText = "Porfolio " + keyVal;
					span.classList.add('currentPortfolioHighlight');
					span.addEventListener("click", function(){
						localPortfolioDetails["currentPortfolioId"] = keyVal;
						localStorage.setItem("portfolioDetails", JSON.stringify(localPortfolioDetails));
						location.reload();
					})
					li.appendChild(span);


				}
				else{
					const span = document.createElement("span");
					span.innerText = "Porfolio " + keyVal;
					span.addEventListener("click", function(){
						localPortfolioDetails["currentPortfolioId"] = keyVal;
						localStorage.setItem("portfolioDetails", JSON.stringify(localPortfolioDetails));
						location.reload();
					})
					span.addEventListener("mouseover", () => {
						span.classList.add("portfolioHighlight");
					})
					span.addEventListener("mouseout", () => {
						span.classList.remove("portfolioHighlight");
					})
					const delBtn = document.createElement("button");
					delBtn.classList.add("btn");
					delBtn.classList.add("btn-danger");
					delBtn.innerText = "Del";
					li.appendChild(span);
					li.appendChild(delBtn);
					delBtn.addEventListener("click", function(){
						const delLiId = Number(this.parentElement.id.replace("portfolio", ""));
						delete localPortfolioDetails[delLiId];
						localStorage.setItem("portfolioDetails", JSON.stringify(localPortfolioDetails));
						
						portfolioLis.removeChild(this.parentElement);

					})

				}
				portfolioLis.appendChild(li);

			}
		})
		addPortfolio.addEventListener("click", () => {
			if(Object.keys(localPortfolioDetails).length < 5){
				localPortfolioDetails[localPortfolioDetails['portfolioId']] = {

					"userAmount":1000,
					"userStocks":{},
					"userFriends":{},
					"portfolioValue":0

					}
					const li = document.createElement("li");
			li.id = "portfolio" + localPortfolioDetails['portfolioId'];
			const span = document.createElement("span");
			const tempId = localPortfolioDetails['portfolioId'];
			span.innerText = "Porfolio " + tempId;
			span.addEventListener("click", function(){
				localPortfolioDetails["currentPortfolioId"] = tempId;
				localStorage.setItem("portfolioDetails", JSON.stringify(localPortfolioDetails));
				location.reload();
			})
			span.addEventListener("mouseover", () => {
				span.classList.add("portfolioHighlight");
			})
			span.addEventListener("mouseout", () => {
				span.classList.remove("portfolioHighlight");
			})
			const delBtn = document.createElement("button");
			delBtn.classList.add("btn");
			delBtn.classList.add("btn-danger");
			delBtn.innerText = "Del";
			li.appendChild(span);
			
			delBtn.addEventListener("click", function(){
				const delLiId = Number(this.parentElement.id.replace("portfolio", ""));
				delete localPortfolioDetails[delLiId];
				localStorage.setItem("portfolioDetails", JSON.stringify(localPortfolioDetails));
				portfolioLis.removeChild(this.parentElement);
				

			})
			li.appendChild(delBtn);
			portfolioLis.appendChild(li);
			localPortfolioDetails['portfolioId'] += 1;
			localStorage.setItem("portfolioDetails", JSON.stringify(localPortfolioDetails))

			}
			
			
			
			
			
		})
		
        let userStocks = localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'];
		userAmount.innerText = "Amount Left: $" + localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userAmount'].toFixed(2);
		portfolioValue.innerText = "Portfolio Value: $" + localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['portfolioValue'].toFixed(2);
		let totalPortfolioVal = 0;
		
        let chartDates = [];
        let chartDataPromises = [];
        let currentDate = new Date();
        let dateIter = 1;
        while(chartDates.length < 5){
          let tempDate = new Date(currentDate);
          tempDate.setDate(tempDate.getDate() - dateIter);
          if(tempDate.getDay() >= 1 && tempDate.getDay() <= 5){
            chartDates.push(formatDate(tempDate));
          }
          dateIter++;

        }
        chartDates.reverse();
		let chartData = [{
			type:"scatter",
			mode:"lines",
			name:"",
			x:chartDates,
			y:[null,null,null,null,null]
		}]
		Plotly.newPlot('portfolioGraph', chartData);
        if(Object.keys(userStocks).length > 0){
          Object.keys(userStocks).forEach(ticker => {
			if(userStocks[ticker] > 0){
				chartDataPromises.push(getStockPrices(ticker, chartDates, userStocks[ticker]));
			}
            
            
          })
          Promise.all(chartDataPromises)
          .then(chartData => {
            Plotly.newPlot('portfolioGraph', chartData);
          })          
        }
        
        
      })
          
    </script>
  </body>
</html>
