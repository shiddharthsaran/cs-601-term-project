<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stock Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="./styles/stockDetails.css" rel="stylesheet">
  </head>
  
  <body class="bg-black">

	<div class="container align-items-center justify-content-center wrapper text-white bg-dark">
		<div class="col-lg-4 offset-lg-3 col-sm-4">
			<a id="homeBtn" href="index.html" class="btn btn-light">Home</a>
		</div>
		<div>
			<div class="col-lg-4 offset-lg-4 col-sm-4 offset-sm-5 col-4 offset-4">
				<div id="stockNameLogo" class="justify-content-lg-center">
					<img src="" id="stockLogo" alt="Stock Logo">
					<p id="stockName"></p>
				</div>
			</div>
			<div class="col-lg-6 offset-lg-3 col-sm-12">
				<p>Description:</p>
				<p id="description"></p>
			</div>
			<div class="col-lg-4 offset-lg-3 col-sm-12">
				<p id="listDate"></h3>
				<p id="tickerSymbol"></p>
				<p id="marketCap"></p>
			</div>
			<div class="col-lg-4 offset-lg-3 col-sm-12">
				<p>Latest Stock Price Details:</p>
				<ul>
					<li id="date"></li>
					<li id="op"></li>
					<li id="hp"></li>
					<li id="lp"></li>
					<li id="cp"></li>
				</ul>
			</div>
			<div class="col-lg-4 offset-lg-4 col-sm-6 offset-sm-5 col-8 offset-3">
				<div id="buySellBtns" class="justify-content-lg-center">
					<button id="buyBtn" class="btn btn-primary">Buy</button>
					<button id="sellBtn" class="btn btn-warning">Sell</button>
				</div>
			</div>
			<div class="col-lg-6 offset-lg-3 col-sm-12 col-8 offset-1">
				<div id="buyDiv">
					<label for="stockQuantity">Select Stock Quantity to buy:</label>
					<input id="stockQuantity" type="number" step="0.1" min="0.1" value="0.1">
					<button id="checkoutBtn" class="btn btn-success">Confirm</button>
					<button id="buyBackBtn" class="btn btn-light">Back</button>
					<div class="col-lg-6 offset-lg-3 col-sm-6 offset-sm-3 col-12 justify-content-lg-center">
						<div>
							<p id="stockBuyMsg"></p>
						</div>

					</div>
					
					
				</div>
			</div>
			<div class="col-lg-6 offset-lg-3 col-sm-12 col-8 offset-1">
				<div id="sellDiv">
					<label for="stockSellQuantity">Select Stock Quantity to sell:</label>
					<input id="stockSellQuantity" type="number" min="0.1" step="0.1">
					<button id="sellConfirmBtn" class="btn btn-success">Confirm</button>
					<button id="sellBackBtn" class="btn btn-light">Back</button>
					<div class="col-lg-6 offset-lg-3 col-sm-6 offset-sm-3 col-12 justify-content-lg-center">
						<div>
							<p id="stockSellMsg"></p>
						</div>

					</div>
				</div>

			</div>
			<div class="col-lg-6 offset-lg-3 col-sm-12">
				<div id="candlestickChartContainer"></div>
				<div class="justify-content-lg-center timeSeries">
					<input type="date" id="startDate">
					<input type="date" id="endDate">
					<button class="btn btn-secondary" id="timeSeriesBtn">Submit</button>
					
				</div>
				<div class="col-lg-6 offset-lg-3 col-sm-12 offset-sm-3 col-8 offset-3  justify-content-lg-center">
					<div class="justify-content-lg-center timeSeriesError">
						<p id="timeSeriesError"></p>
					</div>
					
				</div>
			</div>


		</div>
	</div>
	<!-- <a id="homeBtn" href="index.html" class="btn btn-dark">Home</a>
    <div id="stockDetails">
		<div id="stockNameLogo">
			<img src="" id="stockLogo" alt="Stock Logo">
			<h2 id="stockName"></h2>
			
		</div>
		<h2>Description:</h2>
		<p id="description"></p>
	
		<div></div>
	
		<h3 id="listDate"></h3>
		<h3 id="tickerSymbol"></h3>
		<h3 id="marketCap"></h3>
	
		<h3>Latest Stock Price Details:</h3>
		<ul>
			<li id="date"></li>
			<li id="op"></li>
			<li id="hp"></li>
			<li id="lp"></li>
			<li id="cp"></li>
		</ul>
		<div id="buySellBtns">
			<button id="buyBtn" class="btn btn-primary">Buy</button>
			<button id="sellBtn" class="btn btn-warning">Sell</button>
		</div>
		<div id="buyDiv">
			<label for="stockQuantity">Select Stock Quantity to buy:</label>
			<input id="stockQuantity" type="number" step="0.1" min="0.1" value="0.1">
			<button id="checkoutBtn" class="btn btn-success">Checkout</button>
			<button id="buyBackBtn" class="btn btn-light">Back</button>
			<p id="stockBuyMsg"></p>
		</div>
		<div id="sellDiv">
			<label for="stockSellQuantity">Select Stock Quantity to sell:</label>
			<input id="stockSellQuantity" type="number" min="0.1" step="0.1">
			<button id="sellConfirmBtn" class="btn btn-success">Confirm</button>
			<button id="sellBackBtn" class="btn btn-light">Back</button>
			<p id="stockSellMsg"></p>
		</div>
		<div id="candlestickChartContainer" style="width: 800px; height: 400px;"></div>
			<input type="date" id="startDate">
			<input type="date" id="endDate">
			<button class="btn btn-secondary" id="timeSeriesBtn">Submit</button>
			<p id="timeSeriesError"></p>
		</div> -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
		<script type="module">
        import {getStockDetails} from './modules/main.js'
        import {getStockTimeSeries} from './modules/main.js'
        import {checkStartEndDate} from './modules/main.js'
		
        document.addEventListener("DOMContentLoaded", function(){
			const timeSeriesBtn = document.getElementById('timeSeriesBtn');
			const buyBtn = document.getElementById("buyBtn");
			const sellBtn = document.getElementById("sellBtn");
			const buySellBtns = document.getElementById("buySellBtns");
			const buyDiv = document.getElementById("buyDiv");
			const sellDiv = document.getElementById("sellDiv");
			const checkoutBtn = document.getElementById("checkoutBtn");
			const homeBtn = document.getElementById("homeBtn");
			const buyBackBtn = document.getElementById("buyBackBtn");
			const sellBackBtn = document.getElementById("sellBackBtn");
			const stockSellQuantity = document.getElementById("stockSellQuantity");
			const sellConfirmBtn = document.getElementById("sellConfirmBtn");
			const stockSellMsg = document.getElementById("stockSellMsg");
			const stockLogo = document.getElementById("stockLogo");
			let localPortfolioDetails = JSON.parse(localStorage.getItem('portfolioDetails'));
			
			let params = new URLSearchParams(window.location.search);
			let ticker = params.get("ticker");
			getStockDetails(ticker);
			if(localPortfolioDetails == null){
				let portfolioDetails = {
					"currentPortfolioId":1,
					1:{

						"userAmount":1000,
						"userStocks":{},
						"userFriends":{}

					}
				};
				localStorage.setItem('portfolioDetails',JSON.stringify(portfolioDetails));
				localPortfolioDetails = JSON.parse(localStorage.getItem('portfolioDetails'));
			}

			timeSeriesBtn.addEventListener("click", function(){
			const startDate = document.getElementById("startDate").value;
			const endDate = document.getElementById("endDate").value;
			if(checkStartEndDate(startDate, endDate)){
				const urlTimeSeries = "https://api.polygon.io/v2/aggs/ticker/"+ ticker +"/range/1/day/"+ startDate +"/" + endDate + "?adjusted=true&sort=desc&limit=30&apiKey=" + "UqR1AwHB4eIRO0pUzjG8IxuMlFHeJczI";
				getStockTimeSeries(urlTimeSeries, false);
			}

			})

			buyBtn.addEventListener("click",() => {
				buySellBtns.style.display = "none";
				buyDiv.style.display = "block";
			})
			homeBtn.addEventListener("click", () => {

			})
			if(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'].hasOwnProperty(ticker)){
				if(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker] <= 0){
					sellBtn.style.display = "none";
				}
			}
			else{
				sellBtn.style.display = "none";	
			}
			checkoutBtn.addEventListener("click", function(){
				const stockQuantityVal = Number(stockQuantity.value);
				const latestClosePrice = Number(document.getElementById("cp").innerText.replace("Close Price: ",""));
				if (stockQuantityVal <= 0){
					stockBuyMsg.innerText = "Enter a value greater than 0.";
				}
				else{
					if((localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'].hasOwnProperty(ticker)) || Object.keys(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks']).length < 5){
						let totalBuyAmount = stockQuantityVal * latestClosePrice;
						if((totalBuyAmount) < Number(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userAmount'])){
							localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userAmount'] = localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userAmount'] - totalBuyAmount;
							if(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'].hasOwnProperty(ticker)){
								localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker] += stockQuantityVal;
								
							}
							else{
								localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker] = stockQuantityVal;
							}
							localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['portfolioValue'] += totalBuyAmount;
							localStorage.setItem('portfolioDetails',JSON.stringify(localPortfolioDetails));
							stockBuyMsg.innerText = "Transaction Completed Successfully.";
							
						}
						else{
							stockBuyMsg.innerText = "Amount not enough to buy the number of stock units selected.";
						}

					}else{
						stockBuyMsg.innerText = "Max number of stocks added to portfolio."
					}
					
					
				}
			})

			buyBackBtn.addEventListener("click", function(){
				buySellBtns.style.display = "flex";
				buyDiv.style.display = "none";
				if(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'].hasOwnProperty(ticker)){
					if(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker] > 0){
						sellBtn.style.display = "inline";
					}
				}
				stockBuyMsg.innerText = "";
				
				stockQuantity.value = 0.1;

			})

			sellBackBtn.addEventListener("click", function(){
				buySellBtns.style.display = "flex";
				sellDiv.style.display = "none";
				if(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'].hasOwnProperty(ticker)){
					if(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker] <= 0){
						sellBtn.style.display = "none";
						stockSellQuantity.value = 0;
					}
					else{
						stockSellQuantity.value = localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker];
					}
				}
				else{
					sellBtn.style.display = "none";
				}
				stockSellMsg.innerText = "";
				
			})

			sellBtn.addEventListener("click", () => {
				buySellBtns.style.display = "none";
				sellDiv.style.display = "block";
				stockSellQuantity.value = localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker];

			})
			sellConfirmBtn.addEventListener("click", function(){
				const stockSellQuantityVal = Number(stockSellQuantity.value);
				const latestClosePrice = Number(document.getElementById("cp").innerText.replace("Close Price: ",""));
				
				if(stockSellQuantityVal <= localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker]){
					localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker] -= stockSellQuantityVal;
					localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userAmount'] += stockSellQuantityVal * latestClosePrice;
					if(localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker] == 0){
						delete localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['userStocks'][ticker];
					}
					localPortfolioDetails[localPortfolioDetails['currentPortfolioId']]['portfolioValue'] -= stockSellQuantityVal * latestClosePrice;
					localStorage.setItem('portfolioDetails',JSON.stringify(localPortfolioDetails));
					stockSellMsg.innerText = "Transaction Completed Successfully.";
				}
				else{
					stockSellMsg.innerText = "Selected number of stock units is greater than avaible stock units in user portfolio."
				}

			})




        })
        

    </script>
  </body>
</html>
