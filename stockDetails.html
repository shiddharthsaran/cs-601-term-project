<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stock Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="./styles/stockDetails.css" rel="stylesheet">
  </head>
  
  <body>
	<a id="homeBtn" href="index.html" class="btn btn-dark">Home</a>
    <div id="stockDetails">
      <h2 id="stockName"></h2>
      <h2>Description:</h2>
      <p id="description"></p>
  
      <div></div>
  
      <h3 id="listDate"></h3>
      <h3 id="tickerSymbol"></h3>
      <h3 id="marketCap"></h3>
  
      <h3>Latest Stock Price Details:</h3>
      <ul>
          <li id="date"></li>
          <li id="op"></li>
          <li id="hp"></li>
          <li id="lp"></li>
          <li id="cp"></li>
      </ul>
      <div id="buySellBtns">
        <button id="buyBtn" class="btn btn-primary">Buy</button>
        <button id="sellBtn" class="btn btn-warning">Sell</button>
      </div>
      <div id="buyDiv">
        <label for="stockQuantity">Select Stock Quantity to buy:</label>
        <input id="stockQuantity" type="number" step="0.1" min="0.1" value="0.1">
        <button id="checkoutBtn" class="btn btn-success">Checkout</button>
        <p id="stockBuyMsg"></p>
      </div>
      <div id="candlestickChartContainer" style="width: 800px; height: 400px;"></div>
      <input type="date" id="startDate">
      <input type="date" id="endDate">
      <button class="btn btn-secondary" id="timeSeriesBtn">Submit</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script type="module">
        import {getStockDetails} from './modules/main.js'
        import {getStockTimeSeries} from './modules/main.js'
        import {checkStartEndDate} from './modules/main.js'
		
        document.addEventListener("DOMContentLoaded", function(){
			const timeSeriesBtn = document.getElementById('timeSeriesBtn');
			const buyBtn = document.getElementById("buyBtn");
			const sellBtn = document.getElementById("sellBtn");
			const buySellBtns = document.getElementById("buySellBtns");
			const buyDiv = document.getElementById("buyDiv");
			const checkoutBtn = document.getElementById("checkoutBtn");
			const homeBtn = document.getElementById("homeBtn");
			let localUserDetails = JSON.parse(localStorage.getItem('userDetails'));
			let params = new URLSearchParams(window.location.search);
			let ticker = params.get("ticker");
			getStockDetails(ticker);
			if(localUserDetails == null){
				let userDetails = {
					"userAmount":1000,
					"userStocks":{},
					"userFriends":{}
				};
				localStorage.setItem('userDetails',JSON.stringify(userDetails));
				localUserDetails = JSON.parse(localStorage.getItem('userDetails'));
			}

			timeSeriesBtn.addEventListener("click", function(){
			const startDate = document.getElementById("startDate").value;
			const endDate = document.getElementById("endDate").value;
			if(checkStartEndDate(startDate, endDate)){
				const urlTimeSeries = "https://api.polygon.io/v2/aggs/ticker/"+ ticker +"/range/1/day/"+ startDate +"/" + endDate + "?adjusted=true&sort=desc&limit=30&apiKey=" + "UqR1AwHB4eIRO0pUzjG8IxuMlFHeJczI";
				getStockTimeSeries(urlTimeSeries, false);
			}

			})

			buyBtn.addEventListener("click",() => {
				buySellBtns.style.display = "none";
				buyDiv.style.display = "block";
			})
			homeBtn.addEventListener("click", () => {

			})
			checkoutBtn.addEventListener("click", function(){
			const stockQuantityVal = Number(stockQuantity.value);
			const latestClosePrice = Number(document.getElementById("cp").innerText.replace("Close Price: ",""));
			if (stockQuantityVal <= 0){
				stockBuyMsg.innerText = "Enter a value greater than 0.";
			}
			else{
				let totalBuyAmount = stockQuantityVal * latestClosePrice;
				if((totalBuyAmount) < Number(localUserDetails['userAmount'])){
					localUserDetails['userAmount'] = localUserDetails['userAmount'] - totalBuyAmount;
					if(localUserDetails['userStocks'].hasOwnProperty(ticker)){
						localUserDetails['userStocks'][ticker] += stockQuantityVal;
						
					}
					else{
						localUserDetails['userStocks'][ticker] = stockQuantityVal;
					}
					localStorage.setItem('userDetails',JSON.stringify(localUserDetails));
					stockBuyMsg.innerText = "Transaction Completed Successfully.";
					
				}
				else{
					stockBuyMsg.innerText = "Amount not enough to buy the number of stock units selected.";
				}
				
			}
			})

        })
        

    </script>
  </body>
</html>
